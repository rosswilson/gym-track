version: v1.0

# Name of your pipeline.
name: Gym Track Pipeline

# An agent defines the environment in which your code runs.
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

# Blocks make up the structure of a pipeline and are executed sequentially.
blocks:
  - name: Set up
    task:
      jobs:
      - name: compile and build
        commands:
          # Checkout code from Git repository.
          - checkout

          - sem-version elixir 1.8.1

          # Restore dependencies from cache.
          - cache restore mix-deps-$SEMAPHORE_GIT_BRANCH-$(checksum mix.lock),mix-deps-$SEMAPHORE_GIT_BRANCH,mix-deps-master
          - cache restore mix-build-$SEMAPHORE_GIT_BRANCH-$(checksum mix.lock),mix-build-$SEMAPHORE_GIT_BRANCH,mix-build-master

          - mix deps.get
          - mix do compile, dialyzer --plt
          - MIX_ENV=test mix compile

          # Store deps after compilation.
          - cache store mix-deps-$SEMAPHORE_GIT_BRANCH-$(checksum mix.lock) deps
          - cache store mix-build-$SEMAPHORE_GIT_BRANCH-$(checksum mix.lock) _build

  - name: Analyze code
    task:
      # Commands in prologue run at the beginning of each parallel job.
      prologue:
        commands:
        - checkout
        - bin/setup_ci_elixir
        - sem-version elixir 1.8.1
        - cache restore mix-deps-$SEMAPHORE_GIT_BRANCH-$(checksum mix.lock)
        - cache restore mix-build-$SEMAPHORE_GIT_BRANCH-$(checksum mix.lock)
      jobs:
      - name: formatter
        commands:
        - mix format --check-formatted

  - name: Run tests
    task:
      prologue:
        commands:
        - checkout
        - bin/setup_ci_elixir
        - sem-version elixir 1.8.1
        - cache restore mix-deps-$SEMAPHORE_GIT_BRANCH-$(checksum mix.lock)
        - cache restore mix-build-$SEMAPHORE_GIT_BRANCH-$(checksum mix.lock)

      jobs:
      - name: ex_unit
        env_vars:
        - name: DATABASE_URL
          value: "ecto://postgres:@0.0.0.0:5432/sema_test"
        commands:
        - sem-service start postgres
        - mix test